// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Supported property types for filtering and UI
enum PropertyType {
  HOUSE
  APARTMENT
  CONDO
  TOWNHOUSE
  STUDIO
  LAND
  COMMERCIAL
}

// User roles for authorization
enum Role {
  USER
  OWNER
  REALTOR
  AGENCY
  ADMIN
}

enum ReviewStatus {
  PUBLISHED
  PENDING
  HIDDEN
  REMOVED
}

enum ReviewReportReason {
  SPAM
  OFFENSIVE
  FAKE
  OTHER
}

enum ReviewReportStatus {
  OPEN
  RESOLVED
  DISMISSED
}

// Property status
enum PropertyStatus {
  ACTIVE
  PAUSED
  DRAFT
  SOLD
  RENTED
}

// Finalidade do an√∫ncio
enum Purpose {
  SALE
  RENT
}

// Floor finish types (from form)
enum FinishFloor {
  PORCELANATO
  MADEIRA
  VINILICO
  OUTRO
}

// Sun orientation
enum SunOrientation {
  NASCENTE
  POENTE
  OUTRA
}

// Lead status
enum LeadStatus {
  PENDING // Aguardando candidaturas
  MATCHING // Buscando corretor (tem candidatos)
  WAITING_REALTOR_ACCEPT // Aguardando corretor priorit√°rio aceitar (10min)
  WAITING_OWNER_APPROVAL // Aguardando propriet√°rio aprovar hor√°rio
  CONFIRMED // Visita confirmada!
  OWNER_REJECTED // Propriet√°rio recusou hor√°rio
  CANCELLED // Cliente cancelou
  COMPLETED // Visita realizada
  EXPIRED // Expirou
  ACCEPTED // Deprecated - manter compatibilidade
  REJECTED // Deprecated - manter compatibilidade
  RESERVED // Deprecated - manter compatibilidade
  AVAILABLE // Deprecated - manter compatibilidade
}

// Est√°gios comerciais do funil do corretor
enum LeadPipelineStage {
  NEW
  CONTACT
  VISIT
  PROPOSAL
  DOCUMENTS
  WON
  LOST
}

// Motivos simples de perda de lead
enum LeadLostReason {
  CLIENT_DESISTIU
  FECHOU_OUTRO_IMOVEL
  CONDICAO_FINANCEIRA
  NAO_RESPONDEU
  OUTRO
}

enum LeadEventType {
  LEAD_CREATED
  LEAD_ACCEPTED
  LEAD_REJECTED
  LEAD_COMPLETED
  LEAD_LOST
  STAGE_CHANGED
  NOTE_ADDED
  INTERNAL_MESSAGE
  CLIENT_MESSAGE
  REMINDER_SET
  REMINDER_CLEARED
  VISIT_REQUESTED
  VISIT_CONFIRMED
  VISIT_REJECTED
  OWNER_APPROVAL_REQUESTED
  SIMILAR_LIST_SHARED
  SIMILAR_PROPERTY_INTEREST
}

// Status do corretor na fila
enum RealtorQueueStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Status da candidatura
enum CandidatureStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
  createdAt  DateTime @default(now())
  hidden     Boolean  @default(false)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
  @@map("favorites")
}

model Property {
  id          String         @id @default(cuid())
  title       String
  metaTitle   String?
  metaDescription String?
  description String
  price       Int // price in BRL cents for precision
  type        PropertyType
  status      PropertyStatus @default(ACTIVE)
  purpose     Purpose?
  ownerId     String?
  owner       User?          @relation("PropertyOwner", fields: [ownerId], references: [id])
  teamId      String?
  team        Team?          @relation(fields: [teamId], references: [id])

  // Location & address
  street       String
  neighborhood String?
  city         String
  state        String
  postalCode   String?
  latitude     Float
  longitude    Float

  // Optional details that improve UX in filters/cards
  bedrooms      Int?
  bathrooms     Float?
  areaM2        Int?
  // Amenities/extra metadata
  suites        Int?
  parkingSpots  Int?
  floor         Int?
  furnished     Boolean?
  petFriendly   Boolean?
  condoFee      Int? // in cents
  yearBuilt     Int?
  conditionTags String[] @default([]) // Tags: Mobiliado, Novo, Em constru√ß√£o, etc.

  // ============================
  // EXTRA FIELDS FROM OWNER FORM
  // ============================
  // Lazer / Condom√≠nio
  hasBalcony      Boolean?
  hasElevator     Boolean?
  hasPool         Boolean?
  hasGym          Boolean?
  hasPlayground   Boolean?
  hasPartyRoom    Boolean?
  hasGourmet      Boolean?
  hasConcierge24h Boolean?

  // Acessibilidade
  accRamps              Boolean?
  accWideDoors          Boolean?
  accAccessibleElevator Boolean?
  accTactile            Boolean?

  // Conforto / Energia
  comfortAC           Boolean?
  comfortHeating      Boolean?
  comfortSolar        Boolean?
  comfortNoiseWindows Boolean?
  comfortLED          Boolean?
  comfortWaterReuse   Boolean?

  // Acabamentos
  finishFloor          FinishFloor?
  finishCabinets       Boolean?
  finishCounterGranite Boolean?
  finishCounterQuartz  Boolean?

  // Vista / Posi√ß√£o
  viewSea       Boolean?
  viewCity      Boolean?
  positionFront Boolean?
  positionBack  Boolean?
  sunByRoomNote String?

  // Pets / Pol√≠ticas
  petsSmall  Boolean?
  petsLarge  Boolean?
  condoRules String?

  // Outros
  sunOrientation SunOrientation?
  yearRenovated  Int?
  totalFloors    Int?

  // ============================
  // DADOS PRIVADOS DO PROPRIET√ÅRIO
  // (Vis√≠veis apenas para o dono do an√∫ncio)
  // ============================
  privateOwnerName       String?   // Nome do propriet√°rio
  privateOwnerPhone      String?   // Telefone do propriet√°rio
  privateOwnerEmail      String?   // Email do propriet√°rio
  privateOwnerAddress    String?   // Endere√ßo do propriet√°rio (para visitas, etc.)
  privateOwnerPrice      Int?      // Valor que o propriet√°rio quer (em centavos)
  privateBrokerFeePercent Float?   // Taxa de corretagem em percentual (ex: 5.0 = 5%)
  privateBrokerFeeFixed  Int?      // Taxa de corretagem fixa (em centavos)
  privateExclusive       Boolean?  @default(false) // Exclusividade do corretor
  privateExclusiveUntil  DateTime? // Data limite da exclusividade
  privateOccupied        Boolean?  @default(false) // Im√≥vel est√° ocupado?
  privateOccupantInfo    String?   // Quem mora, contrato, etc.
  privateKeyLocation     String?   // Onde est√° a chave do im√≥vel
  privateNotes           String?   // Observa√ß√µes internas do corretor

  // ============================
  // CONFIGURA√á√ïES DE VISIBILIDADE P√öBLICA
  // (Permite ocultar informa√ß√µes do an√∫ncio p√∫blico)
  // ============================
  hidePrice        Boolean? @default(false) // Ocultar pre√ßo (mostrar "Consulte")
  hideExactAddress Boolean? @default(false) // Ocultar endere√ßo exato (mostrar s√≥ bairro/cidade)
  hideOwnerContact Boolean? @default(false) // Ocultar contato do propriet√°rio
  hideCondoFee     Boolean? @default(false) // Ocultar taxa de condom√≠nio
  hideIPTU         Boolean? @default(false) // Ocultar IPTU
  iptuYearly       Int?                     // Valor anual do IPTU (em centavos)

  // üÜï Controle de leads
  allowRealtorBoard Boolean? @default(false) // Se true, leads v√£o para o mural; se false, contato direto

  images    Image[]
  documents PropertyDocument[]
  favorites Favorite[]
  leads     Lead[]
  views     PropertyView[]
  reports   Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, state])
  @@index([price])
  @@index([type])
  @@index([purpose])
  @@index([ownerId])
  @@index([status])
  @@index([teamId])
  @@map("properties")
}

model Image {
  id          String  @id @default(cuid())
  url         String
  alt         String?
  sortOrder   Int     @default(0)
  blurDataURL String?

  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  createdAt DateTime @default(now())

  @@index([propertyId])
  @@map("images")
}

// Documentos anexados ao im√≥vel (escritura, IPTU, contratos, etc.)
model PropertyDocument {
  id          String              @id @default(cuid())
  property    Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId  String
  
  name        String              // Nome do documento (ex: "Escritura", "IPTU 2024")
  fileName    String              // Nome original do arquivo
  url         String              // URL do arquivo (storage)
  mimeType    String?             // Tipo do arquivo (application/pdf, etc)
  sizeBytes   Int?                // Tamanho em bytes
  category    DocumentCategory    @default(OTHER)
  
  // Controle de visibilidade
  isPublic    Boolean             @default(false) // Se true, cliente pode ver; se false, s√≥ o dono
  
  uploadedBy  String?             // ID do usu√°rio que fez upload
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([propertyId])
  @@index([category])
  @@map("property_documents")
}

enum DocumentCategory {
  DEED        // Escritura
  IPTU        // IPTU
  CONDO       // Boleto/contrato condom√≠nio
  CONTRACT    // Contrato de loca√ß√£o/venda
  FLOOR_PLAN  // Planta baixa
  INSPECTION  // Laudo/vistoria
  PHOTO_360   // Tour virtual / fotos 360
  OTHER       // Outros
}

/// Saved searches per user
model SavedSearch {
  id        String   @id @default(cuid())
  userId    String
  label     String
  params    String // serialized querystring
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("saved_searches")
}

model PropertyDraft {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  data        Json
  currentStep Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("property_drafts")
}

// NextAuth models (Prisma Adapter)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_at        Int?    @map("expires_at")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  passwordHash  String?
  image         String?
  role          Role      @default(USER)

  // Perfil p√∫blico
  publicSlug           String? @unique
  publicProfileEnabled Boolean @default(false)
  publicHeadline       String?
  publicBio            String?
  publicCity           String?
  publicState          String?
  publicPhoneOptIn     Boolean @default(false)

  // Redes sociais p√∫blicas
  publicInstagram       String?
  publicLinkedIn        String?
  publicWhatsApp        String? // N√∫mero com c√≥digo do pa√≠s (5581999999999)
  publicFacebook        String?

  // √Åreas de atua√ß√£o
  publicServiceAreas    String[] // Bairros/regi√µes que o corretor atua

  accounts             Account[]
  sessions             Session[]
  leads                Lead[]
  realtorLeads         Lead[]               @relation("RealtorLeads")
  leadMessages         LeadMessage[]
  properties           Property[]           @relation("PropertyOwner")
  queue                RealtorQueue?
  stats                RealtorStats?
  ratings              RealtorRating[]
  ownerStats           OwnerStats?
  ownerRatings         OwnerRating[]
  ratingsAuthored      RealtorRating[] @relation("RealtorRatingAuthor")
  ownerRatingsAuthored OwnerRating[]   @relation("OwnerRatingAuthor")
  teamMemberships      TeamMember[]
  ownedTeams           Team[]
  agencyProfile        AgencyProfile?
  phone                String?
  phoneVerifiedAt      DateTime?
  realtorApplication   RealtorApplication?
  reviewedApplications RealtorApplication[] @relation("ReviewedApplications")
  reportsCreated       Report[]             @relation("ReportsByUser")
  reportsHandled       Report[]             @relation("ReportsHandledByAdmin")
  reportsAgainstUser   Report[]             @relation("ReportsTargetUser")
  reviewReportsCreated ReviewReport[]       @relation("ReviewReportReportedBy")
  reviewReportsHandled ReviewReport[]       @relation("ReviewReportHandledBy")

  realtorCreci      String?
  realtorCreciState String?
  realtorType       RealtorType?

  // Rascunho de propriedade (1 por usu√°rio)
  propertyDraft     PropertyDraft?
  systemSettings    SystemSetting[] @relation("UserSystemSettings")

  leadRecommendationLists LeadRecommendationList[]
  realtorAssistantItems   RealtorAssistantItem[] @relation("RealtorAssistantItems")
  leadChatReadReceipts    LeadChatReadReceipt[]

  realtorAssistantChatThreads RealtorAssistantChatThread[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Leads submitted from property detail pages
model Lead {
  id         String     @id @default(cuid())
  property   Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String
  user       User?      @relation(fields: [userId], references: [id])
  userId     String?
  realtor    User?      @relation("RealtorLeads", fields: [realtorId], references: [id])
  realtorId  String?
  team       Team?      @relation(fields: [teamId], references: [id])
  teamId     String?
  contact    Contact?   @relation(fields: [contactId], references: [id])
  contactId  String?
  status     LeadStatus @default(PENDING)
  message    String?

  // üÜï CAMPOS DE VISITA
  visitDate   DateTime? // Data da visita agendada
  visitTime   String? // Hor√°rio (ex: "14:00")
  clientNotes String? // Observa√ß√µes do cliente

  // üÜï TIPO DE LEAD
  isDirect Boolean @default(false) // true = contato direto, n√£o vai ao mural

  // üÜï APROVA√á√ÉO DO PROPRIET√ÅRIO
  ownerApproved        Boolean? // null = pendente, true = aprovado, false = recusado
  ownerApprovedAt      DateTime?
  ownerRejectedAt      DateTime?
  ownerRejectionReason String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  respondedAt DateTime?
  confirmedAt DateTime? // Quando visita foi confirmada
  completedAt DateTime? // Quando visita foi realizada
  cancelledAt DateTime?

  // Controle de tempo
  reservedUntil DateTime? // Prazo de reserva para corretor priorit√°rio (10min)
  expiresAt     DateTime? // Prazo de expira√ß√£o do lead

  // Contador de candidatos
  candidatesCount Int @default(0)

  // Est√°gio comercial no funil do corretor
  pipelineStage LeadPipelineStage @default(NEW)

  // Motivo de perda (quando pipelineStage = LOST)
  lostReason LeadLostReason?

  // Lembrete simples de pr√≥ximo passo para o corretor
  nextActionDate DateTime?
  nextActionNote String?

  clientChatToken String? @unique

  candidatures LeadCandidature[]
  rating       RealtorRating?
  ownerRating  OwnerRating?
  reports      Report[]
  clientMessages LeadClientMessage[]

  notes LeadNote[]

  messages LeadMessage[]

  chatReadReceipts LeadChatReadReceipt[]

  events LeadEvent[]

  recommendationLists LeadRecommendationList[]
  assistantItems       RealtorAssistantItem[]
  assistantChatThreads  RealtorAssistantChatThread[]

  @@index([propertyId])
  @@index([userId])
  @@index([realtorId])
  @@index([status])
  @@index([reservedUntil])
  @@index([visitDate, visitTime]) // Para buscar leads por hor√°rio
  @@index([propertyId, visitDate]) // Para verificar conflitos de hor√°rio
  @@index([status, createdAt]) // Para filtrar leads por status + ordenar por data
  @@index([realtorId, status]) // Para buscar leads de um corretor por status
  @@index([status, reservedUntil]) // Para worker de reservas expiradas
  @@index([status, visitDate]) // Para dashboard de visitas
  @@index([teamId])
  @@map("leads")
}

enum RealtorAssistantItemType {
  NEW_LEAD
  UNANSWERED_CLIENT_MESSAGE
  LEAD_NO_FIRST_CONTACT
  LEAD_STUCK_STAGE
  REMINDER_TODAY
  REMINDER_OVERDUE
  VISIT_TODAY
  VISIT_TOMORROW
  OWNER_APPROVAL_PENDING
  SIMILAR_LIST_SHARED_FOLLOWUP
  STALE_LEAD
  PIPELINE_HYGIENE
}

enum RealtorAssistantItemPriority {
  LOW
  MEDIUM
  HIGH
}

enum RealtorAssistantItemStatus {
  ACTIVE
  SNOOZED
  RESOLVED
  DISMISSED
}

enum RealtorAssistantItemSource {
  RULE
  EVENT
  AI
}

model RealtorAssistantItem {
  id        String @id @default(cuid())

  realtor   User   @relation("RealtorAssistantItems", fields: [realtorId], references: [id], onDelete: Cascade)
  realtorId String

  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId String?

  type     RealtorAssistantItemType
  priority RealtorAssistantItemPriority @default(MEDIUM)
  status   RealtorAssistantItemStatus   @default(ACTIVE)
  source   RealtorAssistantItemSource   @default(RULE)

  title   String
  message String

  dueAt        DateTime?
  snoozedUntil DateTime?
  resolvedAt   DateTime?
  dismissedAt  DateTime?

  primaryAction Json?
  secondaryAction Json?
  metadata Json?

  dedupeKey String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([realtorId, dedupeKey])
  @@index([realtorId, status, priority])
  @@index([leadId, status])
  @@index([dueAt])
  @@index([snoozedUntil])
  @@map("realtor_assistant_items")
}

model LeadNote {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  realtorId String
  content   String
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([realtorId])
  @@map("lead_notes")
}

model LeadMessage {
  id         String   @id @default(cuid())
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId     String
  sender     User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId   String
  senderRole Role
  content    String
  createdAt  DateTime @default(now())

  @@index([leadId])
  @@index([senderId])
  @@map("lead_messages")
}

model LeadClientMessage {
  id         String   @id @default(cuid())
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId     String
  fromClient Boolean
  content    String
  createdAt  DateTime @default(now())

  @@index([leadId])
  @@map("lead_client_messages")
}

model LeadChatReadReceipt {
  id         String   @id @default(cuid())
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  lastReadAt DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([leadId, userId])
  @@index([userId])
  @@index([leadId])
  @@map("lead_chat_read_receipts")
}

model LeadEvent {
  id          String         @id @default(cuid())
  lead        Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId      String
  type        LeadEventType
  createdAt   DateTime       @default(now())
  actorId     String?
  actorRole   Role?
  title       String?
  description String?
  fromStage   LeadPipelineStage?
  toStage     LeadPipelineStage?
  fromStatus  LeadStatus?
  toStatus    LeadStatus?
  metadata    Json?

  @@index([leadId, createdAt])
  @@map("lead_events")
}

model LeadRecommendationList {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  realtor   User     @relation(fields: [realtorId], references: [id], onDelete: Cascade)
  realtorId String

  token     String   @unique

  title     String?
  message   String?

  // Lista de im√≥veis recomendados (em ordem)
  propertyIds String[]

  // Snapshot opcional dos filtros/crit√©rio usados para montar a lista
  filters   Json?

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([realtorId])
  @@index([expiresAt])
}

model LeadAssignmentLog {
  id              String   @id @default(cuid())
  leadId          String
  fromRealtorId   String?
  toRealtorId     String?
  changedByUserId String
  teamId          String?
  createdAt       DateTime @default(now())

  @@index([leadId])
  @@index([teamId])
  @@map("lead_assignment_logs")
}

// Contact information for leads
model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  leads     Lead[]
  createdAt DateTime @default(now())

  @@index([email])
  @@map("contacts")
}

// Property views for analytics
model PropertyView {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String
  viewedAt   DateTime @default(now())
  userId     String? // Optional: track logged-in users
  ipAddress  String? // For anonymous tracking

  @@index([propertyId])
  @@index([viewedAt])
  @@map("property_views")
}

model PlatformConversionBenchmark {
  id              String   @id @default(cuid())
  bucketId        String   @unique
  bucketMinDays   Int
  bucketMaxDays   Int?
  propertiesCount Int
  viewsTotal      Int
  leadsTotal      Int
  conversionRate  Float
  calculatedAt    DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([bucketId])
  @@map("platform_conversion_benchmarks")
}

// ============================================
// SISTEMA DE FILA + MURAL DE LEADS
// ============================================

// Fila de corretores
model RealtorQueue {
  id              String             @id @default(cuid())
  realtor         User               @relation(fields: [realtorId], references: [id], onDelete: Cascade)
  realtorId       String             @unique
  position        Int // Posi√ß√£o na fila (1 = primeiro)
  score           Int                @default(0) // Pontua√ß√£o do corretor
  status          RealtorQueueStatus @default(ACTIVE)
  activeLeads     Int                @default(0) // Leads ativos no momento
  bonusLeads      Int                @default(0) // Leads b√¥nus simult√¢neos
  totalAccepted   Int                @default(0) // Total de leads aceitos
  totalRejected   Int                @default(0) // Total de leads recusados
  totalExpired    Int                @default(0) // Total de leads expirados
  avgResponseTime Int? // Tempo m√©dio de resposta em minutos
  lastActivity    DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  candidatures LeadCandidature[]
  scoreHistory ScoreHistory[]

  @@index([position])
  @@index([score])
  @@index([status])
  @@index([status, position]) // Para buscar pr√≥ximo corretor dispon√≠vel
  @@index([status, score]) // Para ordenar por pontua√ß√£o
  @@index([status, activeLeads]) // Para encontrar corretores dispon√≠veis
  @@map("realtor_queue")
}

// Candidaturas de corretores a leads
model LeadCandidature {
  id            String            @id @default(cuid())
  lead          Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId        String
  queue         RealtorQueue      @relation(fields: [queueId], references: [id], onDelete: Cascade)
  queueId       String
  queuePosition Int // üÜï Posi√ß√£o na fila no momento da candidatura
  status        CandidatureStatus @default(PENDING)
  createdAt     DateTime          @default(now())
  respondedAt   DateTime?

  @@unique([leadId, queueId])
  @@index([leadId])
  @@index([queueId])
  @@index([status])
  @@index([leadId, queuePosition]) // Para ordenar candidatos por posi√ß√£o
  @@map("lead_candidatures")
}

// Hist√≥rico de pontua√ß√£o
model ScoreHistory {
  id          String       @id @default(cuid())
  queue       RealtorQueue @relation(fields: [queueId], references: [id], onDelete: Cascade)
  queueId     String
  action      String // Tipo de a√ß√£o (ex: "ACCEPT_LEAD", "REJECT_LEAD")
  points      Int // Pontos ganhos/perdidos
  description String? // Descri√ß√£o da a√ß√£o
  createdAt   DateTime     @default(now())

  @@index([queueId])
  @@index([createdAt])
  @@index([queueId, createdAt]) // Para hist√≥rico de um corretor ordenado por data
  @@map("score_history")
}

// Estat√≠sticas de corretores
model RealtorStats {
  id                 String    @id @default(cuid())
  realtor            User      @relation(fields: [realtorId], references: [id], onDelete: Cascade)
  realtorId          String    @unique
  leadsAccepted      Int       @default(0)
  leadsRejected      Int       @default(0)
  leadsExpired       Int       @default(0)
  leadsCompleted     Int       @default(0)
  visitsScheduled    Int       @default(0)
  visitsCompleted    Int       @default(0)
  avgRating          Float? // Avalia√ß√£o m√©dia (0-5)
  totalRatings       Int       @default(0)
  avgResponseTime    Int? // Em minutos
  totalResponseTime  Int       @default(0) // Soma total para calcular m√©dia
  lastLeadAcceptedAt DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([realtorId])
  @@map("realtor_stats")
}

// Avalia√ß√µes de corretores
model RealtorRating {
  id        String   @id @default(cuid())
  realtor   User     @relation(fields: [realtorId], references: [id], onDelete: Cascade)
  realtorId String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String   @unique

  author   User?   @relation("RealtorRatingAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId String?

  rating  Int // 1-5 estrelas
  comment String?

  status     ReviewStatus @default(PUBLISHED)
  replyText  String?
  repliedAt  DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  reports ReviewReport[]

  @@index([realtorId])
  @@index([leadId])
  @@index([authorId])
  @@index([status])
  @@map("realtor_ratings")
}

model OwnerStats {
  id           String   @id @default(cuid())
  owner        User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId      String   @unique
  avgRating    Float?
  totalRatings Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ownerId])
  @@map("owner_stats")
}

model OwnerRating {
  id      String @id @default(cuid())
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId String
  lead    Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId  String @unique

  author   User?   @relation("OwnerRatingAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId String?

  rating  Int
  comment String?

  status     ReviewStatus @default(PUBLISHED)
  replyText  String?
  repliedAt  DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  reports ReviewReport[]

  @@index([ownerId])
  @@index([leadId])
  @@index([authorId])
  @@index([status])
  @@map("owner_ratings")
}

model ReviewReport {
  id String @id @default(cuid())

  realtorRating   RealtorRating? @relation(fields: [realtorRatingId], references: [id], onDelete: Cascade)
  realtorRatingId String?
  ownerRating     OwnerRating?   @relation(fields: [ownerRatingId], references: [id], onDelete: Cascade)
  ownerRatingId   String?

  reportedBy       User   @relation("ReviewReportReportedBy", fields: [reportedByUserId], references: [id])
  reportedByUserId String

  handledBy        User?   @relation("ReviewReportHandledBy", fields: [handledByAdminId], references: [id])
  handledByAdminId String?

  reason      ReviewReportReason
  description String?
  status      ReviewReportStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([realtorRatingId])
  @@index([ownerRatingId])
  @@index([reportedByUserId])
  @@index([status])
  @@unique([reportedByUserId, realtorRatingId])
  @@unique([reportedByUserId, ownerRatingId])
  @@map("review_reports")
}

enum TeamMemberRole {
  OWNER
  AGENT
  ASSISTANT
}

// Status de aplica√ß√£o de corretor
enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Tipo de corretor
enum RealtorType {
  AUTONOMO
  IMOBILIARIA
}

// Aplica√ß√µes para se tornar corretor
model RealtorApplication {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados profissionais
  cpf         String
  creci       String
  creciState  String // UF do CRECI (PE, BA, etc)
  creciExpiry DateTime
  phone       String
  realtorType RealtorType

  // Documentos (URLs no storage)
  creciDocumentUrl    String?
  identityDocumentUrl String?

  // Informa√ß√µes adicionais
  experience  Int // Anos de experi√™ncia
  specialties String[] // Residencial, Comercial, Rural, etc
  bio         String?

  // Status e revis√£o
  status          ApplicationStatus @default(PENDING)
  reviewedBy      String?
  reviewer        User?             @relation("ReviewedApplications", fields: [reviewedBy], references: [id])
  reviewedAt      DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("realtor_applications")
}

model Team {
  id        String   @id @default(cuid())
  name      String
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId   String
  members   TeamMember[]
  agencyProfile AgencyProfile?
  properties Property[]
  leads      Lead[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@map("teams")
}

model TeamMember {
  id        String         @id @default(cuid())
  team      Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  role      TeamMemberRole @default(AGENT)
  queuePosition Int        @default(0)
  createdAt DateTime       @default(now())

  @@unique([teamId, userId])
  @@index([userId])
  @@map("team_members")
}

model AgencyProfile {
  id      String @id @default(cuid())
  name    String
  cnpj    String @unique
  phone   String?

  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String @unique

  team    Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId  String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([teamId])
  @@map("agency_profiles")
}

// ============================================
// SISTEMA DE DEN√öNCIAS
// ============================================

enum ReportTargetType {
  PROPERTY
  USER
  LEAD
  BUG
  OTHER
}

enum ReportStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  DISMISSED
}

enum ReportReason {
  FAKE_LISTING
  INAPPROPRIATE_PHOTO
  SCAM
  BAD_BEHAVIOR
  BUG
  OTHER
}

enum ReportSeverity {
  LOW
  MEDIUM
  HIGH
}

model Report {
  id String @id @default(cuid())

  reportedBy       User?   @relation("ReportsByUser", fields: [reportedByUserId], references: [id])
  reportedByUserId String?

  targetUser   User?   @relation("ReportsTargetUser", fields: [targetUserId], references: [id])
  targetUserId String?

  handledBy        User?   @relation("ReportsHandledByAdmin", fields: [handledByAdminId], references: [id])
  handledByAdminId String?

  property   Property? @relation(fields: [propertyId], references: [id])
  propertyId String?

  lead   Lead?   @relation(fields: [leadId], references: [id])
  leadId String?

  targetType  ReportTargetType
  reason      ReportReason
  severity    ReportSeverity?
  description String

  status ReportStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([targetType])
}

model SystemSetting {
  key             String   @id
  value           String
  description     String?
  updatedByUser   User?    @relation("UserSystemSettings", fields: [updatedByUserId], references: [id])
  updatedByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("system_settings")
}

enum AuditLogLevel {
  INFO
  WARN
  ERROR
  SUCCESS
}

model AuditLog {
  id         String        @id @default(cuid())
  level      AuditLogLevel @default(INFO)
  action     String
  message    String?
  actorId    String?
  actorEmail String?
  actorRole  Role?
  targetType String?
  targetId   String?
  metadata   Json?
  createdAt  DateTime      @default(now())

  @@index([createdAt])
  @@index([level, createdAt])
  @@index([action])
  @@map("audit_logs")
}

enum RealtorAssistantChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model RealtorAssistantChatThread {
  id        String @id @default(cuid())

  realtor   User   @relation(fields: [realtorId], references: [id], onDelete: Cascade)
  realtorId String

  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId String?

  scopeKey String

  title String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages RealtorAssistantChatMessage[]

  @@unique([realtorId, scopeKey])
  @@index([realtorId])
  @@index([leadId])
  @@index([scopeKey])
  @@map("realtor_assistant_chat_threads")
}

model RealtorAssistantChatMessage {
  id       String @id @default(cuid())

  thread   RealtorAssistantChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  threadId String

  role    RealtorAssistantChatMessageRole
  content String
  data    Json?

  createdAt DateTime @default(now())

  @@index([threadId, createdAt])
  @@map("realtor_assistant_chat_messages")
}
